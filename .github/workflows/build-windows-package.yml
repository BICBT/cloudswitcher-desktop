name: build-windows-package

on:
  push:
    branches:
      - develop
      - master
    tags:
      - '*'

env:
  OSS_BUCKET: ${{ github.ref == 'refs/heads/master' && 'cbt-cloudswitcher-prod' || 'cbt-cloudswitcher-test' }}
  OSS_REGION: ${{ secrets.OSS_REGION }}
  OSS_ACCESS_KEY: ${{ secrets.OSS_ACCESS_KEY }}
  OSS_SECRET_KEY: ${{ secrets.OSS_SECRET_KEY }}
  VERSION: ${{ github.sha }}

jobs:
  build:
    env:
      PUBLISH_FILE_EXT: exe
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Download GTK to install fabricjs (node-canvas)
        # https://github.com/Automattic/node-canvas/wiki/Installation:-Windows
        run: |
          curl -kL http://ftp.gnome.org/pub/gnome/binaries/win64/gtk+/2.22/gtk+-bundle_2.22.1-20101229_win64.zip -o gtk.zip
          7z x gtk.zip -o"c:\\GTK"
        shell: bash

      - name: Npm install
        run: npm ci
        shell: bash

      - name: Update VERSION for releases
        if: startsWith(github.ref, 'refs/tags/')
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        shell: bash

      - name: Build and publish windows package
        run: npm run package:windows:${{ github.ref == 'refs/heads/master' && 'prod' || 'test' }}
        shell: bash
